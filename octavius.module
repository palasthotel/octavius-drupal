<?php
/**
 * Implements hook_preprocess().
 */
/**
 * Implements hook_js_alter().
 */
function octavius_js_alter(){

	/**
	 * get all plugin js
	 */
	$paths = array();
	drupal_alter('octavius_plugins', $paths);


	/**
	 * get all admin plugin js
	 */
	$admin_paths = array();
	drupal_alter('octavius_admin_plugins', $admin_paths);

	/**
	 * add core and config if needed
	 */
	if(count($paths) || count($admin_paths)){
		octavius_add_js('http://dev-edward.service.octavius.rocks/socket.io/socket.io.js',1,'external');
		octavius_add_js('http://dev-edward.service.octavius.rocks/files/octavius.core.v1.0.js',2,'external');
		ob_start();
		include 'config.js.php';
		$config_js = ob_get_contents();
		ob_end_clean();
		octavius_add_js($config_js,12,'inline');
	}

	/**
	 * load plugins
	 */
	foreach($paths as $path){
		octavius_add_js($path);
	}
	foreach($admin_paths as $path){
		octavius_add_js($path);
	}
}

function octavius_add_js($js, $weight = 10, $type = 'file'){
	drupal_add_js(
		$js
		,array(
		'type' => $type,
		'weight' => $weight,
	));
}

function octavius_octavius_plugins_alter(&$paths){
	$base = drupal_get_path('module','octavius');
	$paths[] = $base.'/js/octavius-tracker.js';
}

/**
* Register menus and urls
*/
function octavius_menu() 
{
	return array(
		'admin/config/octavius'=>array(
			'title'=>t('Octavius'),
			'description'=>t('Configure Octavius'),
			'page callback' => 'system_admin_menu_block_page',
		   'file' => 'system.admin.inc',
		   'file path' => drupal_get_path('module', 'system'),
			'access arguments'=>array('setup octavius'),
			'type'=>MENU_NORMAL_ITEM,
		),
		'admin/config/octavius/service'=>array(
			'title'=>t('Service settings'),
			'description'=>t('Configure Octavius service'),
			'page callback'=>'drupal_get_form',
			'page arguments'=>array('octavius_service_settings'),
			'access arguments'=>array('administer octavius'),
			'type'=>MENU_NORMAL_ITEM,
			'weight' => 1,
		),
		'admin/config/octavius/ab'=>array(
			'title'=>t('AB Tests'),
			'description'=>t('Configure AB Tests'),
			'page callback'=>'drupal_get_form',
			'page arguments'=>array('octavius_ab_settings'),
			'access arguments'=>array('setup octavius'),
			'type'=>MENU_NORMAL_ITEM,
			'weight' => 2,
		),
	);
}
/**
*	Grant public access
*/
function octavius_public_access()
{
	return true;
}
/**
*	Register octavius permission.
*/
function octavius_permission() {
  return array(
    'administer octavius' => array(
      'title' => t('Octavius sevice settings'),
      'description' => t('Settings for Octavius service'),
    ),
    'setup octavius' => array(
      'title' => t('Octavius module settings'),
      'description' => t('Performance settings for Octavius module'),
    ),
  );
}
/**
*	Settings page for octavius service
*/
function octavius_service_settings()
{
	$form=array();
	$settings = octavius_get_settings();
	
	$form['service'] = array(
		'#type'=>'fieldset',
		'#title'=>t('Service settings'),
	);

	$form["service"]['octavius_service_api_key'] = array(
		'#type'=>'textfield',
		'#title'=>t('Api Key'),
		'#default_value' => $settings->api_key,
	);

	$form["service"]['octavius_service_url'] = array(
		'#type'=>'textfield',
		'#title' => t('URL to Octavius service (leave empty for default)'),
		'#default_value' => $settings->url,
	);

	return system_settings_form($form);
	
}

/**
*	Settings page for octavius performance
*/
function octavius_ab_settings()
{
	$form=array();
	$settings = octavius_get_settings();

	$form['performance'] = array(
		'#type'=>'fieldset',
		'#title'=>t('Performance settings'),
	);
	$form["performance"]['octavius_page_list_limit'] = array(
		'#type'=>'textfield',
		'#title'=>t('How many Nodes should be delivered on a single Page?'),
		'#default_value' => $settings->page_list_limit,
	);

	return system_settings_form($form);
	
}

/**
 *	Collects all Settings.
 */
function octavius_get_settings()
{
	return (Object) array(
		"api_key" => variable_get("octavius_service_api_key"),
		"url" => variable_get("octavius_service_url", "http://service.octavius.rocks"),
	);
}

/**
 * block for pageviews
 */
function octavius_block_info() {
	$blocks = array();
	$blocks["octavius-pixel"] = array(
		'info' => 'Octavius Pageview Pixel',
		'cache' => DRUPAL_NO_CACHE,
	);
	return $blocks;
}
function octavius_block_view($delta = '') {
	$settings = octavius_get_settings();
	$src = $settings->url."/track/".$settings->api_key;
	ob_start();
	?>
	<img style="height: 0px;width: 0px;overflow: hidden;position: absolute;bottom: 0;left: 0;z-index: -10;" src="<?php echo $src; ?>" />
	<?php
	$content = ob_get_contents();
	ob_end_clean();
	return array('content' => $content);
}
?>